# Script: setup/setup-ssh-multi.ps1
# Description: Configuration SSH pour PC fixe + portable
# Machine: PC FIXE

Write-Host "üîë Configuration SSH Multi-Machines Melyia..." -ForegroundColor Green

# 1. V√©rifier OpenSSH
Write-Host "`nüîç V√©rification OpenSSH..." -ForegroundColor Yellow
if (!(Get-WindowsCapability -Online | Where-Object Name -like "OpenSSH.Client*").State -eq "Installed") {
    Write-Host "üì¶ Installation OpenSSH Client..." -ForegroundColor Yellow
    try {
        Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0
        Write-Host "‚úÖ OpenSSH Client install√©" -ForegroundColor Green
    } catch {
        Write-Host "‚ùå Erreur installation OpenSSH. Installez manuellement depuis Param√®tres Windows" -ForegroundColor Red
        exit 1
    }
} else {
    Write-Host "‚úÖ OpenSSH Client d√©j√† install√©" -ForegroundColor Green
}

# 2. Configuration dossier SSH
$sshDir = "$env:USERPROFILE\.ssh"
Write-Host "`nüìÅ Configuration dossier SSH..." -ForegroundColor Yellow

if (!(Test-Path $sshDir)) {
    New-Item -Path $sshDir -ItemType Directory -Force | Out-Null
    Write-Host "‚úÖ Dossier .ssh cr√©√©: $sshDir" -ForegroundColor Green
} else {
    Write-Host "‚úÖ Dossier .ssh existant: $sshDir" -ForegroundColor Green
}

# 3. G√©n√©rer cl√©s SSH
Write-Host "`nüîê G√©n√©ration cl√©s SSH..." -ForegroundColor Yellow

# Cl√© SSH principale (PC fixe)
$keyPath = "$sshDir\melyia_main"
if (!(Test-Path $keyPath)) {
    Write-Host "üîë G√©n√©ration cl√© SSH principale (PC fixe)..." -ForegroundColor Yellow
    ssh-keygen -t ed25519 -C "melyia-main@$(hostname)" -f $keyPath -N '""'
    if ($LASTEXITCODE -eq 0) {
        Write-Host "‚úÖ Cl√© SSH principale g√©n√©r√©e: $keyPath" -ForegroundColor Green
    } else {
        Write-Host "‚ùå Erreur g√©n√©ration cl√© principale" -ForegroundColor Red
        exit 1
    }
} else {
    Write-Host "‚úÖ Cl√© SSH principale existante: $keyPath" -ForegroundColor Green
}

# Cl√© SSH portable
$portableKeyPath = "$sshDir\melyia_portable"
if (!(Test-Path $portableKeyPath)) {
    Write-Host "üíª G√©n√©ration cl√© SSH portable..." -ForegroundColor Yellow
    ssh-keygen -t ed25519 -C "melyia-portable@multidevice" -f $portableKeyPath -N '""'
    if ($LASTEXITCODE -eq 0) {
        Write-Host "‚úÖ Cl√© SSH portable g√©n√©r√©e: $portableKeyPath" -ForegroundColor Green
    } else {
        Write-Host "‚ùå Erreur g√©n√©ration cl√© portable" -ForegroundColor Red
        exit 1
    }
} else {
    Write-Host "‚úÖ Cl√© SSH portable existante: $portableKeyPath" -ForegroundColor Green
}

# 4. Configuration SSH compl√®te
Write-Host "`n‚öôÔ∏è Configuration SSH..." -ForegroundColor Yellow
$configPath = "$sshDir\config"

# Backup config existant
if (Test-Path $configPath) {
    $backupPath = "$configPath.backup.$(Get-Date -Format 'yyyyMMdd_HHmmss')"
    Copy-Item $configPath $backupPath
    Write-Host "üíæ Backup config SSH: $backupPath" -ForegroundColor Yellow
}

$configContent = @"
# Configuration SSH Melyia - Multi-Machines
# G√©n√©r√©e le $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

# ================================================
# MELYIA BACKEND - Configuration PC Fixe
# ================================================
Host melyia-backend
    HostName 51.91.145.255
    User ubuntu
    Port 22
    IdentityFile ~/.ssh/melyia_main
    ServerAliveInterval 60
    ServerAliveCountMax 3
    ForwardAgent yes
    StrictHostKeyChecking accept-new
    UserKnownHostsFile ~/.ssh/known_hosts
    LogLevel INFO

# ================================================
# MELYIA BACKEND - Configuration Portable
# ================================================
Host melyia-portable
    HostName 51.91.145.255
    User ubuntu
    Port 22
    IdentityFile ~/.ssh/melyia_portable
    ServerAliveInterval 60
    ServerAliveCountMax 3
    ForwardAgent yes
    StrictHostKeyChecking accept-new
    UserKnownHostsFile ~/.ssh/known_hosts
    LogLevel INFO

# ================================================
# RACCOURCIS UTILES
# ================================================

# Monitoring rapide
Host melyia-monitor
    HostName 51.91.145.255
    User ubuntu
    Port 22
    IdentityFile ~/.ssh/melyia_main
    RemoteCommand ./melyia-monitor.sh
    RequestTTY yes

# Logs en temps r√©el
Host melyia-logs
    HostName 51.91.145.255
    User ubuntu
    Port 22
    IdentityFile ~/.ssh/melyia_main
    RemoteCommand "tail -f /var/log/nginx/access.log | grep melyia"
    RequestTTY yes

# Acc√®s PostgreSQL
Host melyia-db
    HostName 51.91.145.255
    User ubuntu
    Port 22
    IdentityFile ~/.ssh/melyia_main
    RemoteCommand "sudo -u postgres psql melyia_dev"
    RequestTTY yes
"@

$configContent | Out-File -FilePath $configPath -Encoding UTF8 -Force
Write-Host "‚úÖ Configuration SSH mise √† jour: $configPath" -ForegroundColor Green

# 5. D√©finir permissions SSH (Windows)
Write-Host "`nüîí Configuration permissions SSH..." -ForegroundColor Yellow
try {
    # Permissions dossier SSH
    icacls $sshDir /inheritance:r | Out-Null
    icacls $sshDir /grant:r "$env:USERNAME:(OI)(CI)F" | Out-Null
    
    # Permissions cl√©s priv√©es
    icacls $keyPath /inheritance:r | Out-Null
    icacls $keyPath /grant:r "$env:USERNAME:R" | Out-Null
    icacls $portableKeyPath /inheritance:r | Out-Null
    icacls $portableKeyPath /grant:r "$env:USERNAME:R" | Out-Null
    
    # Permissions config
    icacls $configPath /inheritance:r | Out-Null
    icacls $configPath /grant:r "$env:USERNAME:R" | Out-Null
    
    Write-Host "‚úÖ Permissions SSH configur√©es" -ForegroundColor Green
} catch {
    Write-Host "‚ö†Ô∏è Attention: Erreur configuration permissions SSH" -ForegroundColor Yellow
    Write-Host "Les cl√©s peuvent fonctionner mais avec un avertissement" -ForegroundColor Yellow
}

# 6. Cr√©er package pour portable
Write-Host "`nüì¶ Cr√©ation package portable..." -ForegroundColor Yellow
$portableSetup = "$env:USERPROFILE\Desktop\melyia-portable-setup"

if (Test-Path $portableSetup) {
    Remove-Item $portableSetup -Recurse -Force
}
New-Item -Path $portableSetup -ItemType Directory -Force | Out-Null

# Copier fichiers n√©cessaires pour portable
Copy-Item "$portableKeyPath" "$portableSetup\"
Copy-Item "$portableKeyPath.pub" "$portableSetup\"

# Cr√©er config SSH adapt√© pour portable
$portableConfig = @"
# Configuration SSH Melyia - PORTABLE
# √Ä copier dans ~/.ssh/config sur le portable

Host melyia-backend
    HostName 51.91.145.255
    User ubuntu
    Port 22
    IdentityFile ~/.ssh/melyia_portable
    ServerAliveInterval 60
    ServerAliveCountMax 3
    ForwardAgent yes
    StrictHostKeyChecking accept-new
    UserKnownHostsFile ~/.ssh/known_hosts

# Raccourcis
Host melyia-monitor
    HostName 51.91.145.255
    User ubuntu
    Port 22
    IdentityFile ~/.ssh/melyia_portable
    RemoteCommand ./melyia-monitor.sh
    RequestTTY yes

Host melyia-logs
    HostName 51.91.145.255
    User ubuntu
    Port 22
    IdentityFile ~/.ssh/melyia_portable
    RemoteCommand "tail -f /var/log/nginx/access.log | grep melyia"
    RequestTTY yes
"@

$portableConfig | Out-File -FilePath "$portableSetup\ssh-config-portable" -Encoding UTF8

# 7. Cr√©er script setup pour portable
$portableScript = @"
# Script: setup-portable.ps1
# Description: Configuration SSH Melyia sur ordinateur portable
# Machine: PORTABLE

Write-Host "üíª Setup Melyia sur ordinateur portable..." -ForegroundColor Green

# 1. V√©rifier OpenSSH
if (!(Get-WindowsCapability -Online | Where-Object Name -like "OpenSSH.Client*").State -eq "Installed") {
    Write-Host "üì¶ Installation OpenSSH Client..." -ForegroundColor Yellow
    Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0
}

# 2. Cr√©er dossier SSH
$sshDir = "$env:USERPROFILE\.ssh"
New-Item -Path $sshDir -ItemType Directory -Force | Out-Null

# 3. Copier les cl√©s SSH
if (Test-Path "melyia_portable") {
    Copy-Item "melyia_portable" "$sshDir\"
    Copy-Item "melyia_portable.pub" "$sshDir\"
    Write-Host "‚úÖ Cl√©s SSH copi√©es" -ForegroundColor Green
} else {
    Write-Host "‚ùå Fichiers cl√©s SSH non trouv√©s dans le dossier actuel" -ForegroundColor Red
    exit 1
}

# 4. Copier configuration SSH
if (Test-Path "ssh-config-portable") {
    Copy-Item "ssh-config-portable" "$sshDir\config"
    Write-Host "‚úÖ Configuration SSH copi√©e" -ForegroundColor Green
} else {
    Write-Host "‚ùå Fichier configuration SSH non trouv√©" -ForegroundColor Red
    exit 1
}

# 5. Permissions Windows
try {
    icacls $sshDir /inheritance:r | Out-Null
    icacls $sshDir /grant:r "$env:USERNAME:(OI)(CI)F" | Out-Null
    icacls "$sshDir\melyia_portable" /inheritance:r | Out-Null
    icacls "$sshDir\melyia_portable" /grant:r "$env:USERNAME:R" | Out-Null
    icacls "$sshDir\config" /inheritance:r | Out-Null
    icacls "$sshDir\config" /grant:r "$env:USERNAME:R" | Out-Null
    Write-Host "‚úÖ Permissions configur√©es" -ForegroundColor Green
} catch {
    Write-Host "‚ö†Ô∏è Attention permissions SSH" -ForegroundColor Yellow
}

# 6. Test connexion
Write-Host "`nüß™ Test connexion SSH..." -ForegroundColor Yellow
ssh -o ConnectTimeout=10 melyia-backend 'echo "‚úÖ SSH portable op√©rationnel !"'

if ($LASTEXITCODE -eq 0) {
    Write-Host "üéâ Setup portable termin√© avec succ√®s !" -ForegroundColor Green
    Write-Host "üìã Vous pouvez maintenant:" -ForegroundColor Cyan
    Write-Host "  1. Cloner le repository Git Melyia" -ForegroundColor White
    Write-Host "  2. Ex√©cuter: .\dev\start-dev.ps1" -ForegroundColor White
    Write-Host "  3. D√©velopper depuis votre portable !" -ForegroundColor White
} else {
    Write-Host "‚ùå Probl√®me de connexion SSH" -ForegroundColor Red
    Write-Host "V√©rifiez que les cl√©s ont √©t√© ajout√©es sur le serveur" -ForegroundColor Yellow
}
"@

$portableScript | Out-File -FilePath "$portableSetup\setup-portable.ps1" -Encoding UTF8

# 8. Instructions serveur
Write-Host "`nüìù G√©n√©ration instructions serveur..." -ForegroundColor Yellow

# R√©cup√©rer les cl√©s publiques
$mainPublicKey = Get-Content "$keyPath.pub" -Raw
$portablePublicKey = Get-Content "$portableKeyPath.pub" -Raw

# Script pour le serveur
$serverScript = @"
#!/bin/bash
# Script: add-keys-server.sh
# Description: Ajouter cl√©s SSH Melyia sur le serveur
# Machine: SERVEUR (51.91.145.255)

echo "üîë Ajout cl√©s SSH Melyia multi-machines..."

# Cr√©er dossier SSH si n√©cessaire
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# Backup authorized_keys existant
if [ -f ~/.ssh/authorized_keys ]; then
    cp ~/.ssh/authorized_keys ~/.ssh/authorized_keys.backup.\$(date +%Y%m%d_%H%M%S)
    echo "üíæ Backup cr√©√©: ~/.ssh/authorized_keys.backup.\$(date +%Y%m%d_%H%M%S)"
fi

# Ajouter cl√© PC fixe
echo '$($mainPublicKey.Trim())' >> ~/.ssh/authorized_keys
echo "‚úÖ Cl√© PC fixe ajout√©e"

# Ajouter cl√© portable
echo '$($portablePublicKey.Trim())' >> ~/.ssh/authorized_keys
echo "‚úÖ Cl√© portable ajout√©e"

# Nettoyer doublons et d√©finir permissions
sort -u ~/.ssh/authorized_keys -o ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

echo ""
echo "üéâ Configuration serveur termin√©e !"
echo "üìã Tests disponibles:"
echo "  ‚Ä¢ Depuis PC fixe: ssh melyia-backend"
echo "  ‚Ä¢ Depuis portable: ssh melyia-backend"
echo "  ‚Ä¢ Monitoring: ssh melyia-monitor"
echo "  ‚Ä¢ Logs: ssh melyia-logs"
"@

$serverScript | Out-File -FilePath "$portableSetup\add-keys-server.sh" -Encoding UTF8

# 9. Instructions compl√®tes
$instructions = @"
# üìã INSTRUCTIONS CONFIGURATION SSH MULTI-MACHINES

## üéØ √âtapes √† suivre

### 1. üñ•Ô∏è Sur le serveur (51.91.145.255)
```bash
# Connectez-vous au serveur
ssh ubuntu@51.91.145.255

# T√©l√©chargez et ex√©cutez le script
# (Copiez le contenu de add-keys-server.sh et ex√©cutez-le)
chmod +x add-keys-server.sh
./add-keys-server.sh
```

### 2. üíª Sur votre ordinateur portable
```powershell
# 1. Copiez tout le dossier portable-setup sur votre portable
# 2. Ouvrez PowerShell dans ce dossier  
# 3. Ex√©cutez:
.\setup-portable.ps1
```

### 3. üß™ Tests de connexion
```powershell
# Depuis PC fixe
ssh melyia-backend

# Depuis portable  
ssh melyia-backend

# Monitoring rapide
ssh melyia-monitor

# Logs en temps r√©el
ssh melyia-logs
```

## üîë Cl√©s g√©n√©r√©es

**PC Fixe:** $keyPath
**Portable:** $portableKeyPath

## üìû En cas de probl√®me

1. V√©rifiez que les cl√©s sont bien ajout√©es sur le serveur
2. Testez la connexion: ssh -v melyia-backend  
3. V√©rifiez les permissions des cl√©s SSH
4. Consultez les logs SSH: ssh -vvv melyia-backend

## ‚úÖ Une fois configur√©

Vous pourrez utiliser:
- .\dev\start-dev.ps1 (d√©marrage d√©veloppement)
- .\dev\sync-and-push.ps1 (synchronisation)  
- ssh melyia-monitor (monitoring serveur)
"@

$instructions | Out-File -FilePath "$portableSetup\INSTRUCTIONS.md" -Encoding UTF8

Write-Host "‚úÖ Package portable cr√©√©: $portableSetup" -ForegroundColor Green

# 10. Affichage final
Write-Host "`nüîë CL√âS SSH G√âN√âR√âES:" -ForegroundColor Cyan
Write-Host "=" * 60 -ForegroundColor Cyan
Write-Host "üñ•Ô∏è CL√â PC FIXE (melyia-backend):" -ForegroundColor Yellow
Write-Host $mainPublicKey -ForegroundColor White
Write-Host "üíª CL√â PORTABLE (melyia-backend):" -ForegroundColor Yellow  
Write-Host $portablePublicKey -ForegroundColor White
Write-Host "=" * 60 -ForegroundColor Cyan

Write-Host "`nüì¶ FICHIERS CR√â√âS:" -ForegroundColor Cyan
Write-Host "‚úÖ $configPath" -ForegroundColor White
Write-Host "‚úÖ $keyPath" -ForegroundColor White
Write-Host "‚úÖ $portableKeyPath" -ForegroundColor White
Write-Host "‚úÖ $portableSetup\" -ForegroundColor White

Write-Host "`nüìã PROCHAINES √âTAPES:" -ForegroundColor Yellow
Write-Host "1. üñ•Ô∏è Connectez-vous au serveur: ssh ubuntu@51.91.145.255" -ForegroundColor White
Write-Host "2. üìù Ex√©cutez le script: add-keys-server.sh (dans portable-setup/)" -ForegroundColor White  
Write-Host "3. üß™ Testez depuis PC fixe: ssh melyia-backend" -ForegroundColor White
Write-Host "4. üíª Copiez portable-setup/ sur votre portable" -ForegroundColor White
Write-Host "5. üíª Ex√©cutez setup-portable.ps1 sur le portable" -ForegroundColor White

Write-Host "`nüí° CONSEIL:" -ForegroundColor Cyan
Write-Host "Copiez ce dossier sur une cl√© USB pour l'installer sur le portable:" -ForegroundColor White
Write-Host "$portableSetup" -ForegroundColor Cyan

Write-Host "`nüéâ Configuration SSH multi-machines termin√©e !" -ForegroundColor Green